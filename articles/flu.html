<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flu Pandemic • epidemia</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Flu Pandemic">
<meta property="og:description" content="epidemia">
<meta property="og:image" content="https://imperialcollegelondon.github.io/epidemia/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS_CHTML.js" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-186908163-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-186908163-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">epidemia</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/install.html">Install</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Model
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/model-description.html">Description</a>
    </li>
    <li>
      <a href="../articles/model-implementation.html">Implementation</a>
    </li>
    <li>
      <a href="../articles/partial-pooling.html">Partial Pooling</a>
    </li>
    <li>
      <a href="../articles/priors.html">Priors</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/flu.html">A Basic Example</a>
    </li>
    <li>
      <a href="../articles/europe-covid.html">A Multilevel Model</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ImperialCollegeLondon/epidemia/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="flu_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Flu Pandemic</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ImperialCollegeLondon/epidemia/blob/master/vignettes/flu.Rmd"><code>vignettes/flu.Rmd</code></a></small>
      <div class="hidden name"><code>flu.Rmd</code></div>

    </div>

    
    
<style>
.contents .page-header {
    display: none;
  } 
</style>
<div class="article_container">


<div id="h1n1-pandemic" class="section level1">
<h1 class="hasAnchor">
<a href="#h1n1-pandemic" class="anchor"></a>1918 H1N1 Pandemic</h1>
<hr>
<p>Here we demonstrate basic usage of <strong>epidemia</strong>; in particular we infer time-varying
reproduction numbers during the 1918 H1N1 Influenza pandemic in Baltimore using
only daily case data and a discrete serial interval. <span class="math inline">\(R_t\)</span> is modeled as
following a weekly random walk. Of course <strong>epidemia</strong> is capable of much more
complex modeling, and such cases are considered in future sections.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">epidemia</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">lubridate</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rstanarm</span>)</pre></body></html></div>
<p>In addition to inferring reproduction numbers and seeded infections, we show
how to do posterior predictive checks and how to extend the model to treats latent infections as
parameters.</p>
<p>First use the following command.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="kw">mc.cores</span> <span class="kw">=</span> <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>())</pre></body></html></div>
<p>This ensure that chains are run in parallel rather than sequentially. The data
for this example is provided by the R package EpiEstim.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">EpiEstim</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="st">"Flu1918"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">Flu1918</span>)</pre></body></html></div>
<pre><code>## $incidence
##  [1]   5   1   6  15   2   3   8   7   2  15   4  17   4  10  31  11  13  36  13
## [20]  33  17  15  32  27  70  58  32  69  54  80 405 192 243 204 280 229 304 265
## [39] 196 372 158 222 141 172 553 148  95 144  85 143  87  73  70  62 116  44  38
## [58]  60  45  60  27  51  34  22  16  11  18  11  10   8  13   3   3   6   6  13
## [77]   5   6   6   5   5   1   2   2   3   8   4   1   2   3   1   0
## 
## $si_distr
##  [1] 0.000 0.233 0.359 0.198 0.103 0.053 0.027 0.014 0.007 0.003 0.002 0.001</code></pre>
<p>First we form the <code>data</code> argument for the model fitting function
<code><a href="../reference/epim.html">epim()</a></code>. Recall that this must contain all observations (case data), and
covariates to fit the model. Since <span class="math inline">\(R_t\)</span> will follow a weekly random walk, the
only covariate required is a <code>week</code> column.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">date</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="st">"1918-01-01"</span>) + <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="kw">along.with</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">NA</span>, <span class="no">Flu1918</span>$<span class="no">incidence</span>))
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">city</span> <span class="kw">=</span> <span class="st">"Baltimore"</span>,
  <span class="kw">cases</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">NA</span>, <span class="no">Flu1918</span>$<span class="no">incidence</span>),
  <span class="kw">date</span> <span class="kw">=</span> <span class="no">date</span>,
  <span class="kw">week</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/week.html">week</a></span>(<span class="no">date</span>)
)</pre></body></html></div>
<p><code>date</code> is constructed so that the first observations are seen on the second
day of the epidemic rather than the first. This is so that the first obervation
can be explained by seeded infections on the previous day.</p>
<p>We need to specify models for <span class="math inline">\(R_t\)</span> and the case data. <span class="math inline">\(R_t\)</span> is modeled through
a call to <code><a href="../reference/epirt.html">epirt()</a></code>. The parameterisation of <span class="math inline">\(R_t\)</span> is defined by the
<code>formula</code> argument. A random walk can be specified using the <code><a href="../reference/rw.html">rw()</a></code>
function. This has an optional <code>time</code> argument which tells <strong>epidemia</strong> which
column in <code>data</code> to use to define the random walk increments. If unspecified it
occurs at the same frequency as <span class="math inline">\(R_t\)</span>, i.e. a daily random walk is used. The random
walk error is modeled as half-normal with a scale hyperparameter. The value of
this is set using the <code>prior_scale</code> argument. This is used in the snippet
below.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">rt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epirt.html">epirt</a></span>(
  <span class="kw">formula</span> <span class="kw">=</span> <span class="fu">R</span>(<span class="no">city</span>, <span class="no">date</span>) ~ <span class="fu"><a href="../reference/rw.html">rw</a></span>(<span class="kw">time</span> <span class="kw">=</span> <span class="no">week</span>, <span class="kw">prior_scale</span> <span class="kw">=</span> <span class="fl">0.1</span>),
  <span class="kw">prior_intercept</span> <span class="kw">=</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">2</span>), <span class="fl">0.2</span>),
  <span class="kw">link</span> <span class="kw">=</span> <span class="st">'log'</span>
)</pre></body></html></div>
<p>In this case the prior on the intercept specifies the prior on <span class="math inline">\(R_0\)</span>. Since a
log link is being used, the prior above gives <span class="math inline">\(R_0\)</span> a prior mean of around 2.</p>
<p>Each observation vector is modeled through a call to <code><a href="../reference/epiobs.html">epiobs()</a></code>. These are
then collected into a list and passed to <code><a href="../reference/epim.html">epim()</a></code> as the <code>obs</code>
argument. In this case only case data is used and so their is only one call
to <code><a href="../reference/epiobs.html">epiobs()</a></code> in the list.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">obs</span> <span class="kw">&lt;-</span>  <span class="fu"><a href="../reference/epiobs.html">epiobs</a></span>(
    <span class="kw">formula</span> <span class="kw">=</span> <span class="no">cases</span> ~ <span class="fl">1</span>,
    <span class="kw">prior_intercept</span> <span class="kw">=</span> <span class="kw pkg">rstanarm</span><span class="kw ns">::</span><span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="kw">location</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">scale</span><span class="kw">=</span><span class="fl">0.01</span>),
    <span class="kw">link</span> <span class="kw">=</span> <span class="st">"identity"</span>,
    <span class="kw">i2o</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">.25</span>,<span class="fl">4</span>)
)</pre></body></html></div>
<p>For the purposes of this exercise we have assumed that roughly all infections
manifest as a case. There is a small symmetric error around this to account for
possible over/under-reporting. The <code>i2o</code> argument implies that cases are
recorded with equal probability in any of the four days post infection.</p>
<p>Finally, we collect all remaining arguments required for <code><a href="../reference/epim.html">epim()</a></code>.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">args</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="kw">rt</span> <span class="kw">=</span> <span class="no">rt</span>,
  <span class="kw">inf</span> <span class="kw">=</span> <span class="fu"><a href="../reference/epiinf.html">epiinf</a></span>(<span class="kw">gen</span> <span class="kw">=</span> <span class="no">Flu1918</span>$<span class="no">si_distr</span>),
  <span class="kw">obs</span> <span class="kw">=</span> <span class="no">obs</span>,
  <span class="kw">data</span> <span class="kw">=</span> <span class="no">data</span>,
  <span class="kw">iter</span> <span class="kw">=</span> <span class="fl">1e3</span>,
  <span class="kw">seed</span> <span class="kw">=</span> <span class="fl">12345</span>
)</pre></body></html></div>
<p>The argument <code>gen</code> takes a discrete generation distribution. Here we have
used the serial interval provided by EpiEstim. <code>algorithm = "sampling"</code>
ensures that the model is fit using Stan’s adaptive HMC sampler. <code>iter</code> and
<code>seed</code> set the number of MCMC iterations and seeds respectively, and are passed
directly on to <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html">rstan::sampling</a></code>.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">fm1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">epim</span>, <span class="no">args</span>)</pre></body></html></div>
<p>The fitted model <code>fm1</code> does not treat infections as latent parameters, and
propagates infections using the renewal process. To extend
the model as described in Section 5.2 of the
<a href="model-description.html">model description</a>, we simply use <code>latent = TRUE</code> in
the call to <code><a href="../reference/epiinf.html">epiinf()</a></code>.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">args</span>$<span class="no">inf</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/epiinf.html">epiinf</a></span>(<span class="kw">gen</span> <span class="kw">=</span> <span class="no">Flu1918</span>$<span class="no">si_distr</span>, <span class="kw">latent</span><span class="kw">=</span><span class="fl">TRUE</span>, <span class="kw">prior_aux</span> <span class="kw">=</span> <span class="fu"><a href="https://mc-stan.org/rstanarm/reference/priors.html">normal</a></span>(<span class="fl">10</span>,<span class="fl">2</span>))
<span class="no">fm2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">epim</span>, <span class="no">args</span>)</pre></body></html></div>
<p>The results of both models are shown in <a href="#fig:flu1918-plots">1</a>. The key difference
stems from the infection process. In the basic model, infections are deterministic
given the reproduction numbers and seeds. However when infection counts are low, we
generally expect high variance in the infection process. Since this
variance is unaccounted for, the model appears to place too much confidence in
the reproduction numbers in this setting. The extended model on the other hand,
has much wider credible intervals for <span class="math inline">\(R\)</span> when infections are low. This is intuitive:
when counts are low, changes in infections could be explained by either the
variance in the offspring distribution of those who are infected, or by changes
in the <span class="math inline">\(R\)</span> value. This model captures this intuition.</p>
<p>Posterior predictive checks are shown in the bottom panel of Figure <a href="#fig:flu1918-plots">1</a>,
and show that both models are able to fit the data well.</p>
<div class="figure">
<span id="fig:flu1918-plots"></span>
<img src="flu_files/figure-html/flu1918-plots-1.png" alt="Reproduction numbers, infections and posterior predictive for both fits. The basic model is shown in the left column, while the right column is for the extended version." width="864"><p class="caption">
Figure 1: Reproduction numbers, infections and posterior predictive for both fits. The basic model is shown in the left column, while the right column is for the extended version.
</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by James Scott, Axel Gandy, Swapnil Mishra, Juliette Unwin, Seth Flaxman, Samir Bhatt.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
